# ChatForward WebSocket 通信协议

## 概述

本文档描述了 ChatForward 插件与 WebSocket 服务器之间的通信协议。协议基于 JSON 格式，支持双向通信。

## 连接建立流程

1. **客户端连接**：客户端连接到配置的 WebSocket URL
2. **身份验证**：连接建立后，客户端立即发送身份验证请求
3. **心跳机制**：身份验证成功后，启动心跳检测机制
4. **消息交换**：双方可以开始正常消息交换

## 消息格式

所有消息都使用 JSON 格式，包含以下通用字段：

```json
{
  "action": "消息类型",
  "timestamp": 1234567890,
  "echo": "请求ID（用于响应匹配）"
}
```

## 客户端到服务器消息

### 1. 身份验证请求
**动作**: `auth`
**描述**: 连接建立后立即发送的身份验证请求

```json
{
  "action": "auth",
  "token": "your_secret_token",
  "timestamp": 1234567890
}
```

**服务器响应**:
```json
{
  "action": "auth",
  "status": "ok",
  "timestamp": 1234567890
}
```

### 2. 心跳请求
**动作**: `ping`
**描述**: 定期发送的心跳检测

```json
{
  "action": "ping",
  "timestamp": 1234567890
}
```

**服务器响应**:
```json
{
  "action": "pong",
  "timestamp": 1234567890
}
```

### 3. 玩家事件通知
**模式**: `PlayerChatEvent`
**描述**: 玩家发送聊天消息时触发

```json
{
  "Mode": "PlayerChatEvent",
  "player": "玩家名称",
  "message": "聊天内容",
  "server": "服务器名称"
}
```

**模式**: `PlayerJoinEvent`
**描述**: 玩家加入服务器时触发

```json
{
  "Mode": "PlayerJoinEvent",
  "player": "玩家名称",
  "server": "服务器名称"
}
```

**模式**: `PlayerLeftEvent`
**描述**: 玩家离开服务器时触发

```json
{
  "Mode": "PlayerLeftEvent",
  "player": "玩家名称"
}
```

**模式**: `PlayerHandoffEvent`
**描述**: 玩家切换服务器时触发

```json
{
  "Mode": "PlayerHandoffEvent",
  "player": "玩家名称",
  "fromserver": "来源服务器",
  "toserver": "目标服务器"
}
```

### 4. 请求-响应模式
**通用格式**:
```json
{
  "action": "请求动作",
  "params": {
    // 请求参数
  },
  "echo": "唯一请求ID"
}
```

## 服务器到客户端消息

### 1. 广播消息
**动作**: `broadcast`
**描述**: 向指定服务器广播消息

```json
{
  "action": "broadcast",
  "message": "要广播的消息内容",
  "target": "all", // 或 "specific_servers"
  "servers": ["server1", "server2"], // 当target为specific_servers时使用
  "echo": "请求ID（可选）"
}
```

### 2. 执行命令
**动作**: `command`
**描述**: 在服务器上执行命令

```json
{
  "action": "command",
  "command": "要执行的命令",
  "executor": "console", // 或 "player_name"
  "echo": "请求ID（可选）"
}
```

### 3. 获取玩家列表
**动作**: `player_list`
**描述**: 请求指定服务器的玩家列表

```json
{
  "action": "player_list",
  "server": "all", // 或具体服务器名称
  "echo": "唯一请求ID"
}
```

**客户端响应**:
```json
{
  "action": "player_list_response",
  "server": "请求的服务器",
  "players": ["玩家1", "玩家2"],
  "count": 2,
  "echo": "请求ID"
}
```

### 4. 获取服务器状态
**动作**: `server_status`
**描述**: 请求服务器状态信息

```json
{
  "action": "server_status",
  "echo": "唯一请求ID"
}
```

**客户端响应**:
```json
{
  "action": "server_status_response",
  "status": {
    "total_players": 10,
    "servers": {
      "lobby": {
        "online": true,
        "player_count": 5,
        "players": ["玩家1", "玩家2"]
      },
      "survival": {
        "online": true,
        "player_count": 5,
        "players": ["玩家3", "玩家4"]
      }
    },
    "online": true,
    "timestamp": 1234567890
  },
  "echo": "请求ID"
}
```

### 5. 玩家列表更新
**模式**: `PlayerListUpdate`
**描述**: 服务器主动推送玩家列表更新

```json
{
  "Mode": "PlayerListUpdate",
  "server": "服务器名称",
  "players": ["玩家1", "玩家2"],
  "timestamp": 1234567890
}
```

## 错误处理

### 错误响应格式
```json
{
  "action": "原动作名称",
  "status": "error",
  "error_code": "错误代码",
  "error_message": "错误描述",
  "echo": "原请求ID（如果适用）",
  "timestamp": 1234567890
}
```

### 常见错误代码
- `auth_failed`: 身份验证失败
- `invalid_token`: 无效的token
- `server_not_found`: 服务器未找到
- `permission_denied`: 权限不足
- `invalid_format`: 消息格式无效
- `timeout`: 请求超时

## 心跳机制

### 心跳间隔
- 客户端每 30 秒发送一次心跳 (`ping`)
- 服务器收到心跳后立即回复 (`pong`)
- 心跳超时时间：60 秒

### 心跳超时处理
如果客户端在 60 秒内未收到服务器的 `pong` 响应，将：
1. 记录警告日志
2. 尝试重新连接
3. 重新进行身份验证

## 重连机制

### 重连策略
- 初始重连间隔：5 秒
- 最大重连尝试次数：10 次
- 使用指数退避算法：`delay = reconnectInterval * reconnectAttempts`

### 重连触发条件
1. 网络连接断开
2. 心跳超时
3. 身份验证失败后
4. 服务器主动断开连接（非正常关闭）

## 消息队列

### 队列机制
当 WebSocket 连接未建立时，所有消息将进入队列。连接建立并身份验证成功后，按顺序发送队列中的消息。

### 队列限制
- 最大队列大小：无限制（使用 ConcurrentLinkedQueue）
- 消息持久化：内存队列，重启后丢失

## 安全考虑

### Token 验证
- 所有连接必须提供有效的 token
- token 在配置文件中配置
- 身份验证失败立即断开连接

### 消息验证
- 所有 JSON 消息必须通过格式验证
- 必填字段缺失将拒绝处理
- 支持的消息类型白名单

## 配置示例

```yaml
websocket:
  url: "ws://localhost:8080/chat"
  token: "your_secret_token_here"
  reconnectInterval: 5000
  maxReconnectAttempts: 10
  heartbeatInterval: 30000
  heartbeatTimeout: 60000

chat:
  mainPrefix: "§8[§a群组§8]§r"
  mcdrCommandPrefix:
    - "!!"
    - "##"
  serverPrefixMapping:
    lobby: "§6大厅"
    survival: "§2生存"
    creative: "§b创造"
    minigame: "§e小游戏"

storage:
  playerPersonalityFile: "player_personality.json"
```

## 事件监听器实现

### 监听器类型
ChatForward 插件实现了以下 Velocity 事件监听器：

1. **PlayerChatListener** - 监听玩家聊天事件
   - 对应 Velocity 事件: `PlayerChatEvent`
   - 发送协议消息: `PlayerChatEvent`
   - 包含字段: `player`, `message`, `server`

2. **PlayerJoinListener** - 监听玩家加入事件
   - 对应 Velocity 事件: `PostLoginEvent`
   - 发送协议消息: `PlayerJoinEvent`
   - 包含字段: `player`, `server`

3. **PlayerLeaveListener** - 监听玩家离开事件
   - 对应 Velocity 事件: `DisconnectEvent`
   - 发送协议消息: `PlayerLeftEvent`
   - 包含字段: `player`

4. **PlayerSwitchServerListener** - 监听玩家切换服务器事件
   - 对应 Velocity 事件: `ServerConnectedEvent`
   - 发送协议消息: `PlayerHandoffEvent`
   - 包含字段: `player`, `fromserver`, `toserver`

### 事件处理流程
1. Velocity 服务器触发事件
2. 对应监听器捕获事件
3. 从事件中提取玩家信息
4. 获取玩家当前服务器名称
5. 调用 WebSocketService 发送对应事件消息
6. WebSocket 服务器接收并处理事件

### 服务器名称映射
监听器使用以下逻辑获取服务器名称：
- 从玩家的 `currentServer` 属性获取服务器信息
- 如果无法获取，使用默认值（如 "login"）
- 服务器名称应与配置中的 `serverPrefixMapping` 键名对应

### 错误处理
- 如果无法获取玩家服务器信息，记录警告日志并跳过事件转发
- 如果 WebSocket 未连接，记录警告日志并跳过事件转发
- 所有异常都被捕获并记录错误日志，避免影响插件正常运行

## 版本历史

### v1.0 (当前)
- 初始版本
- 支持玩家聊天、加入、离开、切换服务器事件
- 支持广播消息、执行命令
- 支持玩家列表和服务器状态查询
- 完整的身份验证和心跳机制
- 自动重连和消息队列

## 附录

### Minecraft 颜色代码
协议支持 Minecraft 颜色代码，将在消息中保留：
- `§0` - `§f`: 颜色代码
- `§k` - `§r`: 格式代码

### 时间戳格式
所有时间戳使用 Unix 时间戳（毫秒）

### 字符编码
使用 UTF-8 编码